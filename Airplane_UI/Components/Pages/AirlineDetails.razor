@page "/airline/details/{id:int}"
@using Airplane_UI.Contracts.AirlineCore
@using Airplane_UI.DTOs.AirlineCore.AirlineDTOs
@using Airplane_UI.Entities.AirlineCore
@using Airplane_UI.Services.AirlineCore
@inject IAirlineService AirlineService

@inject NavigationManager Navigation

<h3>Airline Details</h3>

@if (isLoading)
{
    <p>Loading...</p>
}
else if (airlineDetails == null)
{
    <p>Airline not found.</p>
}
else
{
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">
                @if (isEditing)
                {
                    <input type="text" class="form-control" @bind="editModel.Name" />
                }
                else
                {
                    @airlineDetails.Name
                }
            </h5>
            <p class="card-text">
                <strong>Code:</strong>
                @if (isEditing)
                {
                    <input type="text" class="form-control" @bind="editModel.IATA_Code" />
                }
                else
                {
                    @airlineDetails.IATA_Code
                }
            </p>
        </div>
        <div class="card-footer">
            @if (isEditing)
            {
                <button class="btn btn-success me-2" @onclick="SaveAsync" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <text>Saving...</text>
                    }
                    else
                    {
                        <text>Save</text>
                    }
                </button>
                <button class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
            }
            else
            {
                <button class="btn btn-primary me-2" @onclick="StartEdit">Update</button>
                <button class="btn btn-danger" @onclick="ShowDeleteConfirmation">Delete</button>
            }
        </div>
    </div>

    @if (showDeleteConfirmation)
    {
        <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirm Delete</h5>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete the airline "<strong>@airlineDetails.Name</strong>"?</p>
                        <p>This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" @onclick="DeleteAsync" disabled="@isDeleting">
                            @if (isDeleting)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <text>Deleting...</text>
                            }
                            else
                            {
                                <text>Delete</text>
                            }
                        </button>
                        <button type="button" class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    }
}

@code
{
    [Parameter]
    public int id { get; set; }

    private GetAirlineDTO? airlineDetails;
    private GetAirlineDTO editModel = new();
    private CreateAndUpdateAirlineDTO update = new();
    private bool isLoading = true;
    private bool isEditing = false;
    private bool isSaving = false;
    private bool showDeleteConfirmation = false;
    private bool isDeleting = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            airlineDetails = await AirlineService.GetByIdAsync(id);
        }
        catch (Exception ex)
        {
            // Handle error appropriately
            Console.WriteLine($"Error loading airline details: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void StartEdit()
    {
        if (airlineDetails != null)
        {
            editModel = new GetAirlineDTO
            {
                Id = airlineDetails.Id,
                Name = airlineDetails.Name,
                IATA_Code = airlineDetails.IATA_Code
            };
            isEditing = true;
        }
    }
    private void FinishEdit()
    {
        update = new CreateAndUpdateAirlineDTO
            {
                IATA_Code = airlineDetails.IATA_Code,
                Name = airlineDetails.Name
            };
    }
    private void CancelEdit()
    {
        isEditing = false;
        editModel = new();
        update = new();
    }

    private async Task SaveAsync()
    {
        if (editModel == null) return;

        isSaving = true;
        try
        {
            await AirlineService.UpdateAsync(id, update);
            airlineDetails = editModel;
            isEditing = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating airline: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ShowDeleteConfirmation()
    {
        showDeleteConfirmation = true;
    }

    private void CancelDelete()
    {
        showDeleteConfirmation = false;
    }

    private async Task DeleteAsync()
    {
        isDeleting = true;
        try
        {
            await AirlineService.DeleteAsync(id);
            Navigation.NavigateTo("/airlines"); // Navigate back to airlines list
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting airline: {ex.Message}");
            // Consider adding user notification here
        }
        finally
        {
            isDeleting = false;
            showDeleteConfirmation = false;
        }
    }
}
@* 
Revise this code to be assure that the update and delete beahviors work perfect and correct.

public async Task<GetAirlineDTO> UpdateAsync(int id, CreateAndUpdateAirlineDTO dto)
        {
            var airline = await _context.Airlines.FindAsync(id);
            if (airline == null) return null;

            dto.ToEntity();

            _context.Airlines.Update(airline);
            await _context.SaveChangesAsync();

            return airline.ToDto();
        }

		        public async Task<string> DeleteAsync(int airlineId)
        {
            var airline = await _context.Airlines.FindAsync(airlineId);
            if (airline == null) return null;

            _context.Airlines.Remove(airline);
            await _context.SaveChangesAsync();

            return $"Airport with ID {airlineId} deleted successfully.";
        } *@